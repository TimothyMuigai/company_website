
import sgMail from '@sendgrid/mail';
import { MongoClient } from 'mongodb';

sgMail.setApiKey(process.env.SENDGRID_API_KEY!);

const MONGODB_URI = process.env.MONGODB_URI!;
const MONGODB_DB = process.env.MONGODB_DB!;

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { name, email, message, institution } = body;
    if (!name || !email || !message) {
      return new Response(JSON.stringify({ message: 'Missing required fields' }), { status: 400 });
    }

    // Save to MongoDB
    try {
      const client = await MongoClient.connect(MONGODB_URI);
      const db = client.db(MONGODB_DB);
      await db.collection('news_centre_submissions').insertOne({ name, email, institution, message, date: new Date() });
      client.close();
    } catch (error) {
      return new Response(JSON.stringify({ message: 'Error saving to database', error }), { status: 500 });
    }

    // Send email with SendGrid
    try {
      await sgMail.send({
        to: process.env.ADMIN_EMAIL!,
        from: process.env.SENDGRID_FROM_EMAIL!,
        subject: 'New News Centre Submission',
        text: `Name: ${name}\nEmail: ${email}\nInstitution: ${institution || ''}\nMessage: ${message}`,
      });
    } catch (error) {
      return new Response(JSON.stringify({ message: 'Error sending email', error }), { status: 500 });
    }

    return new Response(JSON.stringify({ message: 'Submission successful' }), { status: 200 });
  } catch (error) {
    return new Response(JSON.stringify({ message: 'Invalid request', error }), { status: 400 });
  }
}

  // Save to MongoDB
  try {
    const client = await MongoClient.connect(MONGODB_URI);
    const db = client.db(MONGODB_DB);
    await db.collection('news_centre_submissions').insertOne({ name, email, message, date: new Date() });
    client.close();
  } catch (error) {
    return res.status(500).json({ message: 'Error saving to database', error });
  }

  // Send email with SendGrid
  try {
    await sgMail.send({
      to: process.env.ADMIN_EMAIL!,
      from: process.env.SENDGRID_FROM_EMAIL!,
      subject: 'New News Centre Submission',
      text: `Name: ${name}\nEmail: ${email}\nMessage: ${message}`,
    });
  } catch (error) {
    return res.status(500).json({ message: 'Error sending email', error });
  }

  res.status(200).json({ message: 'Submission successful' });
}
